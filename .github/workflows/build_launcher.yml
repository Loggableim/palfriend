name: Build Launcher Executable

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-palfriend:
    name: Build palfriend.exe (Main App)
    runs-on: windows-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Build frontend
      working-directory: ./frontend
      run: |
        npm ci
        npm run build
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install "pyinstaller>=6.0.0,<7.0.0"
    
    - name: Build palfriend.exe with PyInstaller
      run: |
        pyinstaller --noconfirm palfriend.spec
    
    - name: Upload palfriend artifact
      uses: actions/upload-artifact@v4
      with:
        name: palfriend-app
        path: dist/palfriend/
        retention-days: 30

  build-launcher:
    name: Build palfriendlauncher.exe (Bootstrapper)
    runs-on: windows-latest
    needs: build-palfriend
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install PyInstaller
      run: |
        python -m pip install --upgrade pip
        pip install "pyinstaller>=6.0.0,<7.0.0"
    
    - name: Download palfriend artifact (optional - for embedding)
      uses: actions/download-artifact@v4
      with:
        name: palfriend-app
        path: dist/palfriend/
      continue-on-error: true
    
    - name: Build palfriendlauncher.exe with PyInstaller
      run: |
        pyinstaller --noconfirm palfriendlauncher.spec
    
    - name: Upload launcher artifact
      uses: actions/upload-artifact@v4
      with:
        name: palfriendlauncher-exe
        path: dist/palfriendlauncher.exe
        retention-days: 30
    
    - name: Create distribution bundle
      run: |
        mkdir release-bundle
        copy dist\palfriendlauncher.exe release-bundle\
        echo "PalFriend Launcher Bundle" > release-bundle\README.txt
        echo "Run palfriendlauncher.exe to install PalFriend" >> release-bundle\README.txt
      shell: cmd
    
    - name: Upload distribution bundle
      uses: actions/upload-artifact@v4
      with:
        name: palfriend-distribution
        path: release-bundle/
        retention-days: 30
